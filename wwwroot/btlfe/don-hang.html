<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒê∆°n h√†ng - Qu·∫£n l√Ω Qu√°n Cafe</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-container">
        <!-- Thanh b√™n (Sidebar) -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">‚òï</div>
                <h2>CAFE MANAGER</h2>
            </div>
            <ul class="sidebar-menu">
                <li class="menu-item">
                    <a href="index.html">
                        <span class="icon">üè†</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="khu-vuc.html">
                        <span class="icon">üìç</span>
                        <span>Khu v·ª±c</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="ban.html">
                        <span class="icon">ü™ë</span>
                        <span>B√†n</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="mon.html">
                        <span class="icon">‚òï</span>
                        <span>M√≥n</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="size.html">
                        <span class="icon">üìè</span>
                        <span>Size m√≥n</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="topping.html">
                        <span class="icon">üßä</span>
                        <span>Topping</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="don-hang.html">
                        <span class="icon">üìã</span>
                        <span>ƒê∆°n h√†ng</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="hoa-don.html">
                        <span class="icon">üßæ</span>
                        <span>H√≥a ƒë∆°n</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="thanh-toan.html">
                        <span class="icon">üí∞</span>
                        <span>Thanh to√°n</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="nguoi-dung.html">
                        <span class="icon">üë•</span>
                        <span>Nh√¢n vi√™n</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="ca-lam.html">
                        <span class="icon">üïê</span>
                        <span>Ca l√†m</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="vai-tro.html">
                        <span class="icon">üîë</span>
                        <span>Vai tr√≤</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" onclick="logout(); return false;">
                        <span class="icon">üö™</span>
                        <span>ƒêƒÉng xu·∫•t</span>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- N·ªôi dung ch√≠nh -->
        <main class="main-content">
            <!-- Thanh ti√™u ƒë·ªÅ (Header) -->
            <header class="header">
                <div class="header-left">
                    <h1>Qu·∫£n l√Ω ƒê∆°n h√†ng</h1>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div class="user-details">
                            <div class="user-name" id="userName">Admin</div>
                            <div class="user-role" id="userRole">Qu·∫£n l√Ω</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Khu v·ª±c n·ªôi dung ch√≠nh -->
            <div class="content">
                <div id="alertContainer"></div>

                <div class="card">
                    <div class="card-header">
                        <h3>Danh s√°ch ƒê∆°n h√†ng</h3>
                    </div>
                    <div class="card-body">
                        <!-- Thanh h√†nh ƒë·ªông (t√¨m ki·∫øm / t·∫°o m·ªõi) -->
                        <div class="action-bar">
                            <div class="search-box">
                                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm ƒë∆°n h√†ng...">
                                <span class="search-icon">üîç</span>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-primary" onclick="openAddModal()">
                                    ‚ûï T·∫°o ƒë∆°n h√†ng
                                </button>
                            </div>
                        </div>

                        <!-- B·∫£ng hi·ªÉn th·ªã danh s√°ch ƒë∆°n h√†ng -->
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>M√£ ƒêH</th>
                                        <th>B√†n</th>
                                        <th>Lo·∫°i</th>
                                        <th>Tr·∫°ng th√°i</th>
                                        <th>M·ªü b·ªüi</th>
                                        <th>M·ªü l√∫c</th>
                                        <th style="text-align: center;">Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody id="donHangTable">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px;">
                                            <div class="spinner"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- C·ª≠a s·ªï (Modal) th√™m ho·∫∑c s·ª≠a ƒë∆°n h√†ng -->
    <div id="donHangModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">T·∫°o ƒë∆°n h√†ng</h3>
                <button class="modal-close" onclick="closeModal('donHangModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="donHangForm">
                    <input type="hidden" id="maDH" name="maDH">

                    <div class="form-row">
                        <div class="form-group">
                            <label for="maBan">B√†n</label>
                            <select id="maBan" name="maBan" class="form-control">
                                <option value="">-- Ch·ªçn b√†n --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="loaiDH">Lo·∫°i ƒë∆°n h√†ng <span style="color: red;">*</span></label>
                            <select id="loaiDH" name="loaiDH" class="form-control" required>
                                <option value="T·∫°i qu√°n">T·∫°i qu√°n</option>
                                <option value="Mang v·ªÅ">Mang v·ªÅ</option>
                                <option value="Giao h√†ng">Giao h√†ng</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="trangThai">Tr·∫°ng th√°i</label>
                            <select id="trangThai" name="trangThai" class="form-control">
                                <option value="M·ªõi">M·ªõi</option>
                                <option value="ƒêang x·ª≠ l√Ω">ƒêang x·ª≠ l√Ω</option>
                                <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                                <option value="ƒê√£ h·ªßy">ƒê√£ h·ªßy</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="moBoi">M·ªü b·ªüi</label>
                            <select id="moBoi" name="moBoi" class="form-control">
                                <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('donHangModal')">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveDonHang()">L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- C·ª≠a s·ªï chi ti·∫øt ƒë∆°n h√†ng -->
    <div id="chiTietModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="chiTietModalTitle">Chi ti·∫øt ƒë∆°n h√†ng</h3>
                <button class="modal-close" onclick="closeModal('chiTietModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="chiTietContent">
                    <div class="spinner"></div>
                </div>

                <!-- Form th√™m m√≥n -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <h4 style="margin-bottom: 15px;">Th√™m m√≥n v√†o ƒë∆°n h√†ng</h4>
                    <form id="themMonForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="chiTietMaMon">M√≥n <span style="color: red;">*</span></label>
                                <select id="chiTietMaMon" name="maMon" class="form-control" required>
                                    <option value="">-- Ch·ªçn m√≥n --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="chiTietMaSize">Size</label>
                                <select id="chiTietMaSize" name="maSize" class="form-control">
                                    <option value="">-- Ch·ªçn size --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="chiTietSoLuong">S·ªë l∆∞·ª£ng <span style="color: red;">*</span></label>
                                <input type="number" id="chiTietSoLuong" name="soLuong" class="form-control" min="1" value="1" required>
                            </div>
                            <div class="form-group">
                                <label for="chiTietDonGia">ƒê∆°n gi√° <span style="color: red;">*</span></label>
                                <input type="number" id="chiTietDonGia" name="donGia" class="form-control" min="0" step="1000" required>
                            </div>
                        </div>
                        <div style="text-align: right; margin-top: 10px;">
                            <button type="button" class="btn btn-primary" onclick="themMonVaoDon()">‚ûï Th√™m m√≥n</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('chiTietModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script src="js/roles.js"></script>
    <script>
        let isEditMode = false;

        // Load dropdown data
        async function loadDropdowns() {
            try {
                // Load b√†n t·ª´ API
                const responseBan = await apiGet('/Ban/get-all');
                const bans = Array.isArray(responseBan) ? responseBan : [];
                const selectBan = document.getElementById('maBan');
                bans.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.maBan;
                    option.textContent = `${item.tenBan} - ${item.tenKhu}`;
                    selectBan.appendChild(option);
                });

                // Load nh√¢n vi√™n t·ª´ API - ch·ªâ l·∫•y Admin (maVT=1) v√† Ph·ª•c v·ª• (maVT=3)
                const responseNV = await apiGet('/NguoiDung/get-all');
                const allNhanViens = responseNV.data || (Array.isArray(responseNV) ? responseNV : []);

                // L·ªçc ch·ªâ l·∫•y Admin (maVT=1) v√† Ph·ª•c v·ª• (maVT=3)
                const nhanViens = allNhanViens.filter(item => item.maVT === 1 || item.maVT === 3);

                const selectNV = document.getElementById('moBoi');
                selectNV.innerHTML = '<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';
                nhanViens.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.maND;
                    option.textContent = item.hoTen;
                    selectNV.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading dropdowns:', error);
                showAlert('L·ªói khi t·∫£i danh s√°ch', 'danger');
            }
        }

        // Load danh s√°ch ƒë∆°n h√†ng
        async function loadDonHang() {
            try {
                // G·ªçi API th·ª±c t·∫ø
                const response = await apiGet('/DonHang/get-all');
                const data = Array.isArray(response) ? response : [];

                const columns = [
                    { field: 'maDH' },
                    { field: 'maBan', render: (item) => item.maBan ? `B√†n ${item.maBan}` : 'N/A' },
                    { field: 'loaiDH' },
                    {
                        field: 'trangThai',
                        render: (item) => {
                            const badgeClass = item.trangThai === 'Ho√†n th√†nh' ? 'badge-success' :
                                item.trangThai === 'ƒêang x·ª≠ l√Ω' ? 'badge-warning' :
                                    item.trangThai === 'M·ªõi' ? 'badge-info' : 'badge-danger';
                            return `<span class="badge ${badgeClass}">${item.trangThai}</span>`;
                        }
                    },
                    { field: 'moBoiTen' },
                    { field: 'moLuc', render: (item) => formatDateTime(item.moLuc) }
                ];

                const actions = (item) => `
                        <div style="text-align: center;">
                            <button class="btn btn-sm btn-info" onclick="viewChiTiet(${item.maDH})" title="Xem chi ti·∫øt">üëÅÔ∏è Chi ti·∫øt</button>
                            <button class="btn btn-sm btn-warning" onclick="editDonHang(${item.maDH})">‚úèÔ∏è S·ª≠a</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteDonHang(${item.maDH})">üóëÔ∏è X√≥a</button>
                        </div>
                    `;

                renderTable('donHangTable', data, columns, actions);
                searchTable('searchInput', 'donHangTable');
            } catch (error) {
                console.error('Error loading don hang:', error);
                showAlert('L·ªói khi t·∫£i danh s√°ch ƒë∆°n h√†ng', 'danger');
            }
        }


        // M·ªü modal th√™m
        function openAddModal() {
            isEditMode = false;
            document.getElementById('modalTitle').textContent = 'T·∫°o ƒë∆°n h√†ng';
            resetForm('donHangForm');
            openModal('donHangModal');
        }

        // S·ª≠a ƒë∆°n h√†ng
        async function editDonHang(id) {
            try {
                // L·∫•y d·ªØ li·ªáu t·ª´ API
                const response = await apiGet('/DonHang/get-all');
                const allData = Array.isArray(response) ? response : [];
                const donHang = allData.find(item => item.maDH === id);

                if (donHang) {
                    isEditMode = true;
                    document.getElementById('modalTitle').textContent = 'S·ª≠a ƒë∆°n h√†ng';
                    fillForm('donHangForm', donHang);
                    openModal('donHangModal');
                }
            } catch (error) {
                console.error('Error loading don hang:', error);
                showAlert('L·ªói khi t·∫£i th√¥ng tin ƒë∆°n h√†ng', 'danger');
            }
        }

        // L∆∞u ƒë∆°n h√†ng
        async function saveDonHang() {
            try {
                const formData = getFormData('donHangForm');

                if (!formData.loaiDH) {
                    showAlert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc', 'warning');
                    return;
                }

                // G·ªçi API
                if (isEditMode) {
                    await apiPut('/DonHang/update', formData);
                    showAlert('C·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh c√¥ng!', 'success');
                } else {
                    await apiPost('/DonHang/add', formData);
                    showAlert('T·∫°o ƒë∆°n h√†ng th√†nh c√¥ng!', 'success');
                }

                closeModal('donHangModal');
                loadDonHang();
            } catch (error) {
                console.error('Error saving don hang:', error);
                showAlert('L·ªói khi l∆∞u ƒë∆°n h√†ng', 'danger');
            }
        }

        // X√≥a ƒë∆°n h√†ng
        async function deleteDonHang(id) {
            if (!confirmDelete('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë∆°n h√†ng n√†y?')) {
                return;
            }

            try {
                await apiDelete(`/DonHang/delete/${id}`);
                showAlert('X√≥a ƒë∆°n h√†ng th√†nh c√¥ng!', 'success');
                loadDonHang();
            } catch (error) {
                console.error('Error deleting don hang:', error);
                showAlert('L·ªói khi x√≥a ƒë∆°n h√†ng', 'danger');
            }
        }

        let currentMaDH = null; // L∆∞u m√£ ƒë∆°n h√†ng hi·ªán t·∫°i ƒëang xem

        // Load danh s√°ch m√≥n v√† size cho form th√™m m√≥n
        async function loadMonVaSize() {
            try {
                // Load m√≥n
                const responseMon = await apiGet('/Mon/get-all');
                const mons = responseMon.data || (Array.isArray(responseMon) ? responseMon : []);
                const selectMon = document.getElementById('chiTietMaMon');
                selectMon.innerHTML = '<option value="">-- Ch·ªçn m√≥n --</option>';
                mons.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.maMon;
                    option.textContent = item.tenMon;
                    selectMon.appendChild(option);
                });

                // Load size
                const responseSize = await apiGet('/SizeMon/get-all');
                const sizes = responseSize.data || (Array.isArray(responseSize) ? responseSize : []);
                const selectSize = document.getElementById('chiTietMaSize');
                selectSize.innerHTML = '<option value="">-- Ch·ªçn size --</option>';
                sizes.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.maSize;
                    option.textContent = `${item.tenMon} - ${item.tenSize} (${formatCurrency(item.gia)})`;
                    option.dataset.gia = item.gia; // L∆∞u gi√° ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn
                    selectSize.appendChild(option);
                });

                // Khi ch·ªçn size, t·ª± ƒë·ªông ƒëi·ªÅn gi√°
                selectSize.addEventListener('change', function () {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption.dataset.gia) {
                        document.getElementById('chiTietDonGia').value = selectedOption.dataset.gia;
                    }
                });
            } catch (error) {
                console.error('Error loading mon and size:', error);
            }
        }

        // Xem chi ti·∫øt ƒë∆°n h√†ng
        async function viewChiTiet(maDH) {
            try {
                currentMaDH = maDH; // L∆∞u m√£ ƒë∆°n h√†ng
                document.getElementById('chiTietModalTitle').textContent = `Chi ti·∫øt ƒë∆°n h√†ng #${maDH}`;
                document.getElementById('chiTietContent').innerHTML = '<div class="spinner"></div>';
                openModal('chiTietModal');

                // Load danh s√°ch m√≥n v√† size
                await loadMonVaSize();

                // L·∫•y th√¥ng tin ƒë∆°n h√†ng
                const responseDH = await apiGet('/DonHang/get-all');
                const allDonHang = Array.isArray(responseDH) ? responseDH : [];
                const donHang = allDonHang.find(item => item.maDH === maDH);

                // L·∫•y chi ti·∫øt ƒë∆°n h√†ng
                await loadChiTietDonHang(maDH, donHang);
            } catch (error) {
                console.error('Error loading chi tiet:', error);
                document.getElementById('chiTietContent').innerHTML = '<p style="color: red;">L·ªói khi t·∫£i chi ti·∫øt ƒë∆°n h√†ng: ' + error.message + '</p>';
            }
        }

        // Load v√† hi·ªÉn th·ªã chi ti·∫øt ƒë∆°n h√†ng
        async function loadChiTietDonHang(maDH, donHang) {
            try {
                const response = await apiGet(`/ChiTietDonHang/get-by-donhang/${maDH}`);
                const chiTietList = Array.isArray(response) ? response : [];

                let html = '';

                if (donHang) {
                    html += `
                            <div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px;">
                                <h4 style="margin: 0 0 10px 0;">Th√¥ng tin ƒë∆°n h√†ng</h4>
                                <p><strong>M√£ ƒë∆°n h√†ng:</strong> ${donHang.maDH}</p>
                                <p><strong>B√†n:</strong> ${donHang.maBan ? `B√†n ${donHang.maBan}` : 'N/A'}</p>
                                <p><strong>Lo·∫°i:</strong> ${donHang.loaiDH}</p>
                                <p><strong>Tr·∫°ng th√°i:</strong> ${donHang.trangThai}</p>
                                <p><strong>M·ªü b·ªüi:</strong> ${donHang.moBoiTen || 'N/A'}</p>
                                <p><strong>M·ªü l√∫c:</strong> ${formatDateTime(donHang.moLuc)}</p>
                            </div>
                        `;
                }

                if (chiTietList.length > 0) {
                    html += `
                            <h4 style="margin-bottom: 15px;">Danh s√°ch m√≥n ƒë√£ g·ªçi</h4>
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th>T√™n m√≥n</th>
                                            <th>Size</th>
                                            <th>S·ªë l∆∞·ª£ng</th>
                                            <th>ƒê∆°n gi√°</th>
                                            <th>Th√†nh ti·ªÅn</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                    let tongTien = 0;
                    chiTietList.forEach((item, index) => {
                        tongTien += item.thanhTien || 0;
                        html += `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${item.tenMon || 'N/A'}</td>
                                    <td>${item.tenSize || 'N/A'}</td>
                                    <td>${item.soLuong || 0}</td>
                                    <td>${formatCurrency(item.donGia || 0)}</td>
                                    <td><strong>${formatCurrency(item.thanhTien || 0)}</strong></td>
                                </tr>
                            `;
                    });

                    html += `
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: #f0f0f0; font-weight: bold;">
                                            <td colspan="5" style="text-align: right;">T·ªïng ti·ªÅn:</td>
                                            <td>${formatCurrency(tongTien)}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        `;
                } else {
                    html += '<p style="text-align: center; padding: 20px; color: #999;">ƒê∆°n h√†ng n√†y ch∆∞a c√≥ m√≥n n√†o.</p>';
                }

                document.getElementById('chiTietContent').innerHTML = html;
            } catch (error) {
                console.error('Error loading chi tiet:', error);
                document.getElementById('chiTietContent').innerHTML = '<p style="color: red;">L·ªói khi t·∫£i chi ti·∫øt ƒë∆°n h√†ng: ' + error.message + '</p>';
            }
        }

        // Th√™m m√≥n v√†o ƒë∆°n h√†ng
        async function themMonVaoDon() {
            if (!currentMaDH) {
                showAlert('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng', 'danger');
                return;
            }

            try {
                const formData = getFormData('themMonForm');

                if (!formData.maMon || !formData.soLuong || !formData.donGia) {
                    showAlert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc', 'warning');
                    return;
                }

                // Chu·∫©n b·ªã d·ªØ li·ªáu (backend s·∫Ω t√≠nh thanh_tien = so_luong * don_gia)
                const data = {
                    maDH: currentMaDH,
                    maMon: parseInt(formData.maMon),
                    maSize: formData.maSize ? parseInt(formData.maSize) : null,
                    soLuong: parseInt(formData.soLuong) || 1,
                    donGia: parseFloat(formData.donGia) || 0
                };

                // G·ªçi API th√™m m√≥n
                const result = await apiPost('/ChiTietDonHang/add', data);

                showAlert(result.message || 'Th√™m m√≥n v√†o ƒë∆°n h√†ng th√†nh c√¥ng!', 'success');

                // Reset form
                resetForm('themMonForm');
                document.getElementById('chiTietDonGia').value = '';

                // Load l·∫°i chi ti·∫øt ƒë∆°n h√†ng
                const responseDH = await apiGet('/DonHang/get-all');
                const allDonHang = Array.isArray(responseDH) ? responseDH : [];
                const donHang = allDonHang.find(item => item.maDH === currentMaDH);
                await loadChiTietDonHang(currentMaDH, donHang);

            } catch (error) {
                console.error('Error adding mon to don hang:', error);
                showAlert('L·ªói khi th√™m m√≥n v√†o ƒë∆°n h√†ng: ' + error.message, 'danger');
            }
        }

        // Load data khi trang load
        document.addEventListener('DOMContentLoaded', function () {
            loadDropdowns();
            loadDonHang();
        });
    </script>
</body>
</html>


