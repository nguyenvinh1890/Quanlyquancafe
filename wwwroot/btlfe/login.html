<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng nhập - Quản lý Quán Cafe</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="logo">☕</div>
                <h1>QUẢN LÝ QUÁN CAFE</h1>
                <p>Đăng nhập để tiếp tục</p>
            </div>

            <div id="alertContainer"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Tài khoản</label>
                    <input 
                        type="text" 
                        id="username" 
                        name="taiKhoan"
                        class="form-control" 
                        placeholder="Nhập tài khoản"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="password">Mật khẩu</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="matKhau"
                        class="form-control" 
                        placeholder="Nhập mật khẩu"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="vaiTro">Đăng nhập với vai trò</label>
                    <select id="vaiTro" name="vaiTro" class="form-control" required>
                        <option value="">-- Chọn vai trò --</option>
                        <option value="1">Quản lý</option>
                        <option value="2">Thu ngân</option>
                        <option value="3">Phục vụ</option>
                        <option value="4">Pha chế</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">
                    Đăng nhập
                </button>
            </form>

            <div style="text-align: center; margin-top: 20px; color: var(--text-light); font-size: 14px;">
                <p>Phiên bản 1.0 - 2024</p>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script src="js/roles.js"></script>
    <script>
        if (typeof API_BASE_URL === 'undefined') {
            window.API_BASE_URL = 'https://localhost:44390/api';
        }
        
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = getFormData('loginForm');
            
            if (!formData.taiKhoan || !formData.matKhau) {
                showAlert('Vui lòng nhập đầy đủ tài khoản và mật khẩu!', 'warning');
                return;
            }
            
            if (!formData.vaiTro) {
                showAlert('Vui lòng chọn vai trò!', 'warning');
                return;
            }
            
            try {
                const loginData = {
                    taiKhoan: formData.taiKhoan,
                    matKhau: formData.matKhau
                };
                
                const response = await fetch(`${API_BASE_URL}/NguoiDung/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Lỗi không xác định' }));
                    showAlert(errorData.message || `Lỗi ${response.status}: Đăng nhập thất bại!`, 'danger');
                    return;
                }
                
                const result = await response.json();
                
                let token = result && result.token;
                let user = result && result.user;
                
                if (!token && !user && result && result.success && result.data) {
                    const d = result.data;
                    const maND = d.MaND ?? d.maND;
                    const hoTen = d.HoTen ?? d.hoTen;
                    const taiKhoan = d.TaiKhoan ?? d.taiKhoan;
                    const maVT = d.MaVT ?? d.maVT;
                    const tenVaiTro = d.TenVaiTro ?? d.tenVaiTro ?? '';
                    user = { maND, hoTen, taiKhoan, maVT, tenVaiTro };
                    token = `jwt-token-${maND}`;
                }
                
                if (token && user) {
                    const selectedRoleId = parseInt(formData.vaiTro);
                    const userRoleId = parseInt(user.maVT);
                    
                    if (selectedRoleId !== userRoleId) {
                        showAlert(`Tài khoản thuộc vai trò "${user.tenVaiTro}" (ID: ${userRoleId}).`, 'info');
                    }
                    
                    setAuthToken(token);
                    setUserInfo(user);
                    
                    const savedToken = localStorage.getItem('authToken');
                    const savedUser = localStorage.getItem('userInfo');
                    
                    if (!savedToken) {
                        showAlert('Lỗi: Không thể lưu thông tin đăng nhập!', 'danger');
                        return;
                    }
                    
                    showAlert(`Đăng nhập thành công với vai trò ${user.tenVaiTro || 'Nhân viên'}!`, 'success');
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    const verifyToken = localStorage.getItem('authToken');
                    const verifyUser = localStorage.getItem('userInfo');
                    
                    if (!verifyToken || !verifyUser) {
                        showAlert('Lỗi: Không thể lưu thông tin đăng nhập!', 'danger');
                        return;
                    }
                    
                    const dest = `${window.location.origin}/index.html`;
                    
                    try { window.location.replace(dest); } catch (e) {}
                    try { window.location.assign(dest); } catch (e) {}
                    
                    setTimeout(() => {
                        if (window.location.href !== dest) {
                            window.location.href = dest;
                        }
                    }, 500);
                    
                    setTimeout(() => {
                        if (!/index\.html$/i.test(window.location.pathname)) {
                            window.location.href = dest;
                        }
                    }, 1500);
                } else {
                    showAlert(result?.message || 'Đăng nhập thất bại! Dữ liệu không hợp lệ.', 'danger');
                }
            } catch (error) {
                showAlert('Lỗi khi đăng nhập: ' + (error.message || 'Vui lòng thử lại'), 'danger');
            }
        });
    </script>
</body>
</html>
